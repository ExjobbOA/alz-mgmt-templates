name: Continuous Delivery

on:
  workflow_call:
    inputs:
      platform_ref:
        type: string
        default: main
      parameters_file_name:
        description: "Path to JSON parameters file"
        required: false
        type: string
        default: "platform.json"   # <- align with your repo
      skip_what_if:
        default: false
        type: boolean

      governance-int-root:
        type: boolean
        default: true
      governance-landingzones:
        type: boolean
        default: true
      governance-landingzones-corp:
        type: boolean
        default: true
      governance-landingzones-online:
        type: boolean
        default: true
      governance-platform:
        type: boolean
        default: true
      governance-platform-connectivity:
        type: boolean
        default: true
      governance-platform-identity:
        type: boolean
        default: true
      governance-platform-management:
        type: boolean
        default: true
      governance-platform-security:
        type: boolean
        default: true
      governance-sandbox:
        type: boolean
        default: true
      governance-decommissioned:
        type: boolean
        default: true

      governance-platform-rbac:
        type: boolean
        default: true
      governance-platform-connectivity-rbac:
        type: boolean
        default: true
      governance-landingzones-rbac:
        type: boolean
        default: true

      networking:
        type: boolean
        default: true
      core-logging:
        type: boolean
        default: true

jobs:
  whatif:
    name: What If
    runs-on: ubuntu-latest
    concurrency: mgmt-tfstate
    environment: alz-mgmt-plan
    permissions:
      id-token: write
      contents: read
    if: ${{ !inputs.skip_what_if }}
    env:
      PARAMETERS_FILE_NAME: ${{ inputs.parameters_file_name }}

    steps:
      - name: Show inputs
        run: |
          echo '${{ toJson(inputs) }}'

      - name: Checkout Config Repo
        uses: actions/checkout@v4

      - name: Checkout Engine Repo (platform templates)
        uses: actions/checkout@v4
        with:
          repository: ExjobbOA/alz-mgmt-templates
          ref: ${{ inputs.platform_ref }}
          path: platform

      - name: Get Bicep Variables
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-variables@main
        with:
          parameters_file_name: ${{ env.PARAMETERS_FILE_NAME }}

      - name: Install Bicep and Update Az Module
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-installer@main

      - name: Bicep Build & Lint All Modules
        shell: pwsh
        run: |
          $output = @()
          Get-ChildItem -Recurse -Filter '*.bicep' -Exclude '*.bicep' | Where-Object { $_.FullName -notlike "*\.bicep\*" } | ForEach-Object {
              Write-Information "==> Attempting Bicep Build For File: $_" -InformationAction Continue
              $bicepOutput = bicep build $_.FullName 2>&1
              if ($LastExitCode -ne 0)
              {
                foreach ($item in $bicepOutput) {
                  $output += "$($item) `r`n"
                }
              }
              else
              {
                echo "Bicep Build Successful for File: $_"
              }
          }
          if ($output.length -gt 0) {
            throw $output
          }

      - name: OIDC Login to Tenant
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Check for First Deployment
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-first-deployment-check@main
        with:
          managementGroupId: ${{ env.INTERMEDIATE_ROOT_MANAGEMENT_GROUP_ID }}

      # ---- WHAT-IF in proven order (same as Apply order below) ----

      - name: 'Plan: Governance-Intermediate Root'
        if: ${{ inputs.governance-int-root }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-int-root'
          displayName: 'Governance-Intermediate Root'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/int-root/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/int-root.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          managementGroupId: ${{ env.MANAGEMENT_GROUP_ID }}

      - name: 'Plan: Governance-Landing Zones'
        if: ${{ inputs.governance-landingzones }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-landingzones'
          displayName: 'Governance-Landing Zones'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'landingzones'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Landing Zones Corp'
        if: ${{ inputs.governance-landingzones-corp }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-landingzones-corp'
          displayName: 'Governance-Landing Zones Corp'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/landingzones-corp/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/landingzones-corp/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'corp'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Landing Zones Online'
        if: ${{ inputs.governance-landingzones-online }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-landingzones-online'
          displayName: 'Governance-Landing Zones Online'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/landingzones-online/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/landingzones-online/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'online'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform'
        if: ${{ inputs.governance-platform }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform'
          displayName: 'Governance-Platform'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'platform'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform Connectivity'
        if: ${{ inputs.governance-platform-connectivity }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-connectivity'
          displayName: 'Governance-Platform Connectivity'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-connectivity/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-connectivity/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'connectivity'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform Identity'
        if: ${{ inputs.governance-platform-identity }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-identity'
          displayName: 'Governance-Platform Identity'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-identity/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-identity/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'identity'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform Management'
        if: ${{ inputs.governance-platform-management }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-management'
          displayName: 'Governance-Platform Management'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-management/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-management/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'management'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform Security'
        if: ${{ inputs.governance-platform-security }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-security'
          displayName: 'Governance-Platform Security'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-security/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-security/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'security'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Sandbox'
        if: ${{ inputs.governance-sandbox }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-sandbox'
          displayName: 'Governance-Sandbox'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/sandbox/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/sandbox/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'sandbox'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Decommissioned'
        if: ${{ inputs.governance-decommissioned }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-decommissioned'
          displayName: 'Governance-Decommissioned'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/decommissioned/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/decommissioned/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'decommissioned'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform RBAC'
        if: ${{ inputs.governance-platform-rbac }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-rbac'
          displayName: 'Governance-Platform RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'platform'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Platform Connectivity RBAC'
        if: ${{ inputs.governance-platform-connectivity-rbac }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-platform-connectivity-rbac'
          displayName: 'Governance-Platform Connectivity RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-connectivity/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-connectivity/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'connectivity'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Governance-Landing Zones RBAC'
        if: ${{ inputs.governance-landingzones-rbac }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'governance-landingzones-rbac'
          displayName: 'Governance-Landing Zones RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'
          targetManagementGroupId: 'landingzones'
          skipWhatIfIfTargetMgMissing: 'true'

      - name: 'Plan: Networking - Hub'
        if: ${{ inputs.networking }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'networking-hub'
          displayName: 'Networking - Hub'
          templateFilePath: 'platform/templates/networking/hubnetworking/main.bicep'
          templateParametersFilePath: 'config/networking/hubnetworking/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_CONNECTIVITY }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'subscription'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'

      - name: 'Plan: Core-Logging'
        if: ${{ inputs.core-logging }}
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-deploy@main
        with:
          name: 'core-logging'
          displayName: 'Core-Logging'
          templateFilePath: 'platform/templates/core/logging/main.bicep'
          templateParametersFilePath: 'config/core/logging/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'subscription'
          whatIfEnabled: 'true'
          firstRunWhatIf: 'false'

  deploy:
    name: Deploy - Sequential Monolith (Stacks)
    needs: [whatif]
    if: ${{ always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
    runs-on: ubuntu-latest
    concurrency: mgmt-tfstate
    environment: alz-mgmt-apply
    permissions:
      id-token: write
      contents: read
    env:
      PARAMETERS_FILE_NAME: ${{ inputs.parameters_file_name }}
  
    steps:
      - name: Show inputs
        run: |
          echo '${{ toJson(inputs) }}'
  
      - name: Checkout Config Repo
        uses: actions/checkout@v4
  
      - name: Checkout Engine Repo (platform templates)
        uses: actions/checkout@v4
        with:
          repository: ExjobbOA/alz-mgmt-templates
          ref: ${{ inputs.platform_ref }}
          path: platform
  
      - name: Get Bicep Variables
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-variables@main
        with:
          parameters_file_name: ${{ env.PARAMETERS_FILE_NAME }}
  
      - name: Install Bicep and Update Az Module
        uses: ExjobbOA/alz-mgmt-templates/.github/actions/bicep-installer@main
  
      - name: Bicep Build & Lint All Modules
        shell: pwsh
        run: |
          $output = @()
          Get-ChildItem -Recurse -Filter '*.bicep' -Exclude '*.bicep' | Where-Object { $_.FullName -notlike "*\.bicep\*" } | ForEach-Object {
              Write-Information "==> Attempting Bicep Build For File: $_" -InformationAction Continue
              $bicepOutput = bicep build $_.FullName 2>&1
              if ($LastExitCode -ne 0)
              {
                foreach ($item in $bicepOutput) {
                  $output += "$($item) `r`n"
                }
              }
              else
              {
                echo "Bicep Build Successful for File: $_"
              }
          }
          if ($output.length -gt 0) {
            throw $output
          }
  
      - name: OIDC Login to Tenant
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true
  
      # 1) Intermediate Root (MG stack at Tenant Root MG)
      - name: 'Apply: Governance-Intermediate Root'
        if: ${{ inputs.governance-int-root }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-int-root'
          displayName: 'Governance-Intermediate Root'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/int-root/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/int-root.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          managementGroupId: ${{ env.MANAGEMENT_GROUP_ID }}
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 2) Landing Zones (MG stacks at Intermediate Root MG)
      - name: 'Apply: Governance-Landing Zones'
        if: ${{ inputs.governance-landingzones }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-landingzones'
          displayName: 'Governance-Landing Zones'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      - name: 'Apply: Governance-Landing Zones Corp'
        if: ${{ inputs.governance-landingzones-corp }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-landingzones-corp'
          displayName: 'Governance-Landing Zones Corp'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/landingzones-corp/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/landingzones-corp/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      - name: 'Apply: Governance-Landing Zones Online'
        if: ${{ inputs.governance-landingzones-online }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-landingzones-online'
          displayName: 'Governance-Landing Zones Online'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/landingzones-online/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/landingzones-online/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 3) Platform (Base)
      - name: 'Apply: Governance-Platform'
        if: ${{ inputs.governance-platform }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform'
          displayName: 'Governance-Platform'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 4) Platform Connectivity (sub placement)
      - name: 'Apply: Governance-Platform Connectivity'
        if: ${{ inputs.governance-platform-connectivity }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-connectivity'
          displayName: 'Governance-Platform Connectivity'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-connectivity/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-connectivity/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
  
      # 5) Platform Identity
      - name: 'Apply: Governance-Platform Identity'
        if: ${{ inputs.governance-platform-identity }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-identity'
          displayName: 'Governance-Platform Identity'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-identity/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-identity/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 6) Platform Management
      - name: 'Apply: Governance-Platform Management'
        if: ${{ inputs.governance-platform-management }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-management'
          displayName: 'Governance-Platform Management'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-management/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-management/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 7) Platform Security
      - name: 'Apply: Governance-Platform Security'
        if: ${{ inputs.governance-platform-security }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-security'
          displayName: 'Governance-Platform Security'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-security/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-security/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 8) Sandbox & Decommissioned
      - name: 'Apply: Governance-Sandbox'
        if: ${{ inputs.governance-sandbox }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-sandbox'
          displayName: 'Governance-Sandbox'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/sandbox/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/sandbox/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      - name: 'Apply: Governance-Decommissioned'
        if: ${{ inputs.governance-decommissioned }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-decommissioned'
          displayName: 'Governance-Decommissioned'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/decommissioned/main.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/decommissioned/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 9) RBAC stages
      - name: 'Apply: Governance-Platform RBAC'
        if: ${{ inputs.governance-platform-rbac }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-rbac'
          displayName: 'Governance-Platform RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      - name: 'Apply: Governance-Platform Connectivity RBAC'
        if: ${{ inputs.governance-platform-connectivity-rbac }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-platform-connectivity-rbac'
          displayName: 'Governance-Platform Connectivity RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/platform/platform-connectivity/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/platform/platform-connectivity/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      - name: 'Apply: Governance-Landing Zones RBAC'
        if: ${{ inputs.governance-landingzones-rbac }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'governance-landingzones-rbac'
          displayName: 'Governance-Landing Zones RBAC'
          templateFilePath: 'platform/templates/core/governance/mgmt-groups/landingzones/main-rbac.bicep'
          templateParametersFilePath: 'config/core/governance/mgmt-groups/landingzones/main-rbac.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'managementGroup'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 10) Networking (subscription stack)
      - name: 'Apply: Networking - Hub'
        if: ${{ inputs.networking }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'networking-hub'
          displayName: 'Networking - Hub'
          templateFilePath: 'platform/templates/networking/hubnetworking/main.bicep'
          templateParametersFilePath: 'config/networking/hubnetworking/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_CONNECTIVITY }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'subscription'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
  
      # 11) Core-Logging (final step, subscription stack)
      - name: 'Apply: Core-Logging'
        if: ${{ inputs.core-logging }}
        uses: ./platform/.github/actions/bicep-deploy
        with:
          name: 'core-logging'
          displayName: 'Core-Logging'
          templateFilePath: 'platform/templates/core/logging/main.bicep'
          templateParametersFilePath: 'config/core/logging/main.bicepparam'
          subscriptionId: '${{ env.SUBSCRIPTION_ID_MANAGEMENT }}'
          resourceGroupName: ''
          location: '${{ env.LOCATION }}'
          deploymentType: 'subscription'
          whatIfEnabled: 'false'
          firstRunWhatIf: 'false'
          stackNamePrefix: ${{ env.STACK_PREFIX }}
          denySettingsMode: 'None'
          actionOnUnmanage: 'DetachAll'
